#  WORKING WITH THE WEB

Go to APOD.nasa.gov and look at the information provided in the Astronomy Picture of the Day.  We will use this information to determine the layout of our NASA view.

1.  In main.storyboard, add:
Image View, 2 Labels, and a Text View.  Adjust background and text colors as you go.

2.  Set constraints:
    - Image view on top. Set aspect mode to Aspect Fit.
    - Title label below that with height of 40. Set font to Large Title.
    - Copyright label next with a height of 20. Set font to Title 2.
    - Description text view with a height of 350. Set font to body.
    - Embed everyting in a vertical stack view with 0, 0, 0, 0 constraints. Alignment and Distribution = Fill and spacing = 10. Content mode = Scale To Fill.

    By not setting a height on the image but setting it on everything else, it will stretch or shrink based on the size of the device.

3. Create a cocoa touch file called NASAViewController that inherits from UIViewController.  Set the class for the NASA view in the identity inspector to NASAViewController.  Make outlet connections for the image, labels and text view.

4.  In order to perform a network request, you will need a create PhotoInfo type that will adopt the codable protocol.  The codable protocol uses autogenerated methods that will match the property names and values in your type with the keys and values from the API. An enum called CodingKeys is used in your struct to match keys from the API that have different names than the ones you have selected for your porperties.

    Make a new swift file called PhotoInfo that contains a the PhotoInfo struct. 

    struct PhotoInfo: Codable {
    var title: String
    var description: String
    var url: URL
    var copyright: String?
    
    enum CodingKeys: String, CodingKey {
        case title
        case description = "explanation"
        case url
        case copyright
    }
}

5.  a. You will need a function to fetch the photo info.  Create a       new .swift file and name it PhotoInfoController.  Add your          fetchPhotoInfo function to that class.
    b.  You will need to set up an enum at the top called PhotoInfoError to handle the error referenced in the function you created. 

       class PhotoInfoController {
    
        enum PhotoInfoError: Error, LocalizedError {
            case itemsNotFound
            case imageDataMissing
        }


        func fetchPhotoInfo() async throws -> PhotoInfo {
            var urlComponents = URLComponents(string: "https://api.nasa.gov/planetary/apod")!
            urlComponents.queryItems = [
                "api_key": "DEMO_KEY"
            ].map { URLQueryItem(name: $0.key, value: $0.value) }
     
            let (data, response) = try await URLSession.shared.data(from: urlComponents.url!)
     
            guard let httpResponse = response as? HTTPURLResponse,
                httpResponse.statusCode == 200 else {
                throw PhotoInfoError.itemsNotFound
            }
            let jsonDecoder = JSONDecoder()
            let photoInfo = try jsonDecoder.decode(PhotoInfo.self, from: data)
            return(photoInfo)
            }
            
        func fetchImage(from url: URL) async throws -> UIImage {
            let (data, response) = try await URLSession.shared.data(from: url)
        
            guard let httpResponse = response as? HTTPURLResponse,
                httpResponse.statusCode == 200 else {
                throw PhotoInfoError.imageDataMissing
            }
        
            guard let image = UIImage(data: data) else {
                throw PhotoInfoError.imageDataMissing
            }
            return image
        }
    }


7.  In the NASAViewController, do the following:

    a.  add a property for the instance of PhotoInfoController:

        let photoInfoController = PhotoInfoController()
    
    b. Update viewDidLoad() so that it calls the fetchPhotoInfo method and update the title and labels with the result.
    
            override func viewDidLoad() {
        super.viewDidLoad()
        
        titleLabel.text = ""
        nasaImage.image = UIImage(systemName: "photo.on.rectangle")
        descriptionLabel.text = ""
        copyrightLabel.text = ""
        
        Task {
            do {
                let photoInfo = try await
                photoInfoController.fetchPhotoInfo()
                updateUI(with: photoInfo)
            } catch {
                updateUI(with: error)
            }
        }
    }
    
    c. Create updateUI functions for the photo info and for error handling.

        func updateUI(with photoInfo: PhotoInfo) {
            Task {
                do {
                    let image = try await photoInfoController.fetchImage(from:  photoInfo.url)
                    titleLabel.text = photoInfo.title
                    nasaImage.image = image
                    descriptionLabel.text = photoInfo.description
                    copyrightLabel.text = photoInfo.copyright
                } catch {
                    updateUI(with: error)
                }
            }
        }
    
        func updateUI(with error: Error) {  
            title = "Error Fetching Photo"
            nasaImage.image = UIImage(systemName: "exclamationmark.octagon")
            descriptionLabel.text = error.localizedDescription
            copyrightLabel.text = ""
        }
    }

